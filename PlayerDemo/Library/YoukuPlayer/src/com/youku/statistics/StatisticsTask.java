package com.youku.statistics;import android.content.Context;import android.os.AsyncTask;import android.os.Build;import com.baseproject.utils.Logger;import com.youku.player.LogTag;import com.youku.player.util.PlayerUtil;import java.io.IOException;import java.net.HttpURLConnection;import java.net.MalformedURLException;import java.net.URL;/** *  * @author 张宇 * @create-time May 23, 2012 10:37:51 AM * @version $Id *  */public class StatisticsTask extends AsyncTask<Void, Void, Void> {	// 是否失败后重试	private boolean mIsFailRetry = true;	// 接口地址	private String mUrl;	private Context mContext;		private boolean isNeedLogin = false;	private static String TAG = LogTag.TAG_PREFIX + StatisticsTask.class.getSimpleName();	public StatisticsTask(String url, Context context) {		super();		mUrl = url;		mContext = context.getApplicationContext();	}	public StatisticsTask(String url, boolean isFailRetry, Context context) {		super();		mIsFailRetry = isFailRetry;		mUrl = url;		mContext = context.getApplicationContext();	}	public StatisticsTask(String url, Context context, boolean isNeedLogin, boolean isFailRetry) {		super();		mUrl = url;		mContext = context.getApplicationContext();		mIsFailRetry = isFailRetry;		this.isNeedLogin = isNeedLogin;	}		@Override	protected Void doInBackground(Void... params) {		boolean isNeedRetry = false;		try {			// it's android's bug,must set the property to get response code			// correct			disableConnectionReuseIfNecessary();			URL url = new URL(mUrl);			HttpURLConnection urlConnection = (HttpURLConnection) url					.openConnection();			urlConnection.setRequestMethod("POST");			urlConnection.setConnectTimeout(15000);			urlConnection.setRequestProperty("User-Agent", com.baseproject.utils.Profile.User_Agent);			if (isNeedLogin && PlayerUtil.isLogin()) {				urlConnection.setRequestProperty("Cookie", PlayerUtil.getCookie());			}			urlConnection.connect();			final int responseCode = urlConnection.getResponseCode();			Logger.d(TAG, String.valueOf(responseCode));			if (mIsFailRetry && responseCode != HttpURLConnection.HTTP_OK) {				isNeedRetry = true;			}			if (urlConnection != null) {				urlConnection.disconnect();			}		} catch (MalformedURLException e) {		} catch (IOException e) {			if (mIsFailRetry) {				isNeedRetry = true;			}		} catch (Exception e) {			if (mIsFailRetry) {				isNeedRetry = true;			}		}		if (isNeedRetry) {			StatisticsDataManager.write(mUrl, mContext);			Logger.e(TAG, "vv发送失败，已存储，下次重试。");		}		return null;	}	/**	 * Workaround for bug pre-Froyo, see here for more info:	 * http://android-developers.blogspot.com/2011/09/androids-http-clients.html	 */	private void disableConnectionReuseIfNecessary() {		// HTTP connection reuse which was buggy pre-froyo		if (Build.VERSION.SDK_INT < Build.VERSION_CODES.FROYO) {			System.setProperty("http.keepAlive", "false");		}	}}